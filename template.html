<!DOCTYPE html>
<html>

<head>
    <title>Kinesis Hot Shard Advisor Report 2022-03-23 06:30</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.11/jsrender.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: rgb(253, 253, 253);
            font-family: 'Source Sans Pro', sans-serif;
            color: rgb(46, 46, 46);
        }
        li {
            display: inline;
        }
        .nav-item {
            float: left;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div>
        <h1>Kinesis Hot Shard Advisor Report</h1>
    </div>
    <div>
        
        <p>
            The tool reads available shards of the stream one after another at your specified time to calculate the shard level per second consumption and frequently used top 10 partition keys. 
            Ingress graphs indicate how much data was written to a shard on per second basis. It's calculated by reading the stream and aggregating the record size for each second in ApproximateArrivalTimestamp.
            Having more ingress in a shard than others indicates a potential hot shard issue. 
        </p>
        <ul id="report-nav">
        </ul>
        <div style="clear:both"/>
        <div id="report-shard-stats"></div>
    </div>
    <script id="template-nav" type="text/x-jsrender">
        <li class="nav-item">
            {{ trustedHTML `<a href="#shard-stats-{{:shardId}}">{{:shardId}}</a>` }}
            </li>
    </script>
    <script id="template-shard-stats" type="text/x-jsrender">
        <div>
            {{ trustedHTML `<h2 id="shard-stats-{{:shardId}}">{{:shardId}}</h2>` }}
            <h3>Ingress</h3>
            {{ trustedHTML `<canvas id="graph-ingress-{{:shardId}}" width="800px" height="300px"></canvas>` }}
            <h3>Frequent Keys</h3>
            {{ trustedHTML `<canvas id="graph-count-{{:shardId}}" width="800px" height="300px"></canvas>` }}
        </div>
    </script>
    <script>
        function renderGraphs() {
            var secondLabels = [];
            var startTime = report.from;
            for(var shard of report.shards) {
                renderIngressGraph(shard.shardId, shard.stats['ingress'].map((_, i) => new Date((startTime + i) * 1000)), shard.stats['ingress']);
                renderCountGraph(shard.shardId, shard.stats['count'].slice(0, options.limit).map(i => i.partitionKey), shard.stats['count'].slice(0, options.limit).map(i => i.count));
            }
        }

        function renderIngressGraph(shardId, labels, values) {
            var ctx = document.getElementById(`graph-ingress-${shardId}`);
            latencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'bytes/sec',
                        data: values,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    fill: false,
                    responsive: false,
                    elements: {
                        point: {
                            radius: 0
                        },
                        line: {
                            tension: 0.2,
                            borderWidth: 1,

                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderCountGraph(shardId, labels, values) {
            var ctx = document.getElementById(`graph-count-${shardId}`);
            latencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Partition Key Distribution',
                        data: values
                    }]
                },
                options: {
                    responsive: false,
                }
            });
        }

    </script>
    <script>
        const report = {{ .Report }};
        const options = {
            limit: {{ .Limit }}
        };
        {{ trustedJS `$(document).ready(function() {
                $('#report-nav').append($('#template-nav').render(report.shards));
                $('#report-shard-stats').append($('#template-shard-stats').render(report.shards));
                renderGraphs();
           });` }}
    </script>
    
</body>

</html>